# GitHub Copilot Instructions for SanityR

## Project Overview

SanityR is a **Bioconductor R package** providing an R/C++ interface to the
[Sanity model](https://github.com/jmbreda/Sanity) for single-cell RNA-seq
analysis. It implements Bayesian estimation of log-normalized counts and
uncertainty-aware cell distance calculations.

Reference: Breda et al. (2021), *Nature Biotechnology*,
<https://doi.org/10.1038/s41587-021-00875-x>

Open access version: https://www.biorxiv.org/content/10.1101/2019.12.28.889956v1.full.pdf
Use it whenever you have questions about the mathematical background of the methods.

---

## Repository Structure

```
R/           # R source — S4 generics/methods, user-facing functions
src/         # C++ source (Rcpp); compiled into SanityR.so
tests/       # testthat test suite (tests/testthat/)
vignettes/   # knitr/rmarkdown vignettes
man/         # Auto-generated roxygen2 documentation (do not edit manually)
inst/        # CITATION, example data (inst/extdata/), helper scripts
DESCRIPTION  # Package metadata and dependencies
NAMESPACE    # Auto-generated by roxygen2 (do not edit manually)
```

---

## Coding Standards

### R Code — Bioconductor Style

Follow the [Bioconductor coding style guide](https://contributions.bioconductor.org/r-code.html):

- **Indentation**: 4 spaces (no tabs).
- **Line length**: ≤ 100 characters.
- **Naming**: `camelCase` for functions and variables; `snake_case` is acceptable
  for internal helpers. Avoid `.` in function names (conflicts with S3 dispatch).
- **Assignment**: use `<-`, not `=`.
- **S4 classes and methods**: prefer S4 over S3 for new generics; use `setGeneric()` / `setMethod()`.
- **Accessor functions**: expose slots via accessor generics, not `@` in user-facing code.
- **`vapply` over `sapply`**: use `vapply` (with explicit `FUN.VALUE`) for type safety.
- **Avoid `1:n` loops**: use `seq_len(n)` and `seq_along(x)`.
- **No `T`/`F`**: always write `TRUE`/`FALSE` in full.
- **`message()` / `warning()` / `stop()`**: use for user communication, not `cat()` / `print()`.
- **Do not write excessive comments** the code should be self explanatory
  comments should clarify intent or explain decisions. Use existing ones as template.

### Documentation — roxygen2

- All exported functions and S4 methods **must** have roxygen2 documentation.
- Use `@param`, `@return`, `@examples`, `@seealso`, `@references` as appropriate.
- Link to Bioconductor classes with `\linkS4class{ClassName}`.
- Math expressions use `\eqn{}` (inline) or `\deqn{}` (display).
- Run `devtools::document()` (or `roxygen2::roxygenise()`) to regenerate
  `man/` and `NAMESPACE`; **never edit these files by hand**.

### C++ / Rcpp

- Source files live in `src/`; headers use `.h`, implementations use `.cpp`.
- Export C++ functions to R with `// [[Rcpp::export]]`.
- Use `Rcpp::NumericVector`, `Rcpp::NumericMatrix`, etc. (avoid raw pointers where possible).
- Keep heavy numerical routines in C++; thin R wrappers handle S4/validation logic.
- After editing C++ files run `devtools::load_all()` to compile. 

### Parallelization

- Prefer **vectorized** operations over loops.
- Use `BiocParallel::bplapply()` (not `parallel::mclapply`).
- Accept a `BPPARAM` argument in any function that supports parallelization and
  default to `BiocParallel::bpparam()`.

---

## Testing

- Framework: **testthat** (edition 3).
- Test files: `tests/testthat/test-<topic>.R`.
- Run tests: `devtools::test()` or `R CMD check`.
- Each new function or bug fix should have corresponding tests.
- Use `expect_equal()`, `expect_error()`, `expect_warning()`, etc.
- For `SingleCellExperiment` outputs, verify both assay names and `rowData` columns.

---

## Dependencies

- **Imports** (required at runtime): `Rcpp`, `BiocGenerics`, `BiocParallel`,
  `MatrixGenerics`, `methods`, `S4Vectors`, `scuttle`, `SingleCellExperiment`,
  `SummarizedExperiment`.
- **LinkingTo** (compile-time): `Rcpp`.
- **Suggests** (optional/vignette): `BiocStyle`, `knitr`, `rmarkdown`,
  `testthat`, `scater`, `Rtsne`.
- Add new dependencies to `DESCRIPTION` only; never `library()` or `require()`
  in package code — use `::` instead.

---

## Bioconductor Compliance

- Follow the [Bioconductor package guidelines](https://contributions.bioconductor.org/).
- Work within the ["Orchestrating Single-Cell Analysis with Bioconductor"](https://bioconductor.org/books/release/OSCA/) framework.
- `biocViews` tags: `Software`, `GeneExpression`, `SingleCell`, `Normalization`, `Bayesian`.
- Version scheme: `x.y.z` where `y` is even for release, odd for devel.
- Run `BiocCheck::BiocCheck()` and `R CMD check --as-cran` before submitting.
- Avoid `library()` in vignettes; use `suppressPackageStartupMessages(library(...))`.
- Example data lives in `inst/extdata/`; use `system.file()` to access it.

---

## Common Workflows

```r
# Load package during development
devtools::load_all()

# Regenerate documentation
devtools::document()

# Run tests
devtools::test()

# Full R CMD check
devtools::check()

# Bioconductor-specific checks
BiocCheck::BiocCheck()
```
